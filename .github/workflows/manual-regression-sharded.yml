name: On demand regression - sharded

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Optional: override BASE_URL"
        required: false
        default: ""
      marker:
        description: "Optional: pytest marker"
        required: false
        default: ""
      xdist:
        description: "Optional: pytest-xdist -n value"
        required: false
        default: ""
      extra_args:
        description: "Optional: extra pytest args"
        required: false
        default: ""
      reruns:
        description: "Optional: --reruns"
        required: false
        default: ""
      reruns_delay:
        description: "Optional: --reruns-delay"
        required: false
        default: ""

jobs:
  run-tests:
    name: Run tests (sharded)
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      CHROMEDRIVER_LOG: /tmp/chromedriver.log
      GECKODRIVER_LOG: /tmp/geckodriver.log
      EDGEDRIVER_LOG: /tmp/edgedriver.log

    strategy:
      matrix:
        shard_index: [0,1]
        shard_count: [2]

    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Google Chrome (stable)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip
          wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y /tmp/chrome.deb || (sudo apt-get -f install -y && sudo apt install -y /tmp/chrome.deb)
          google-chrome --version

      - name: Cache webdriver-manager (~/.wdm)
        uses: actions/cache@v4
        with:
          path: ~/.wdm
          key: ${{ runner.os }}-wdm-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-wdm-

      - name: Install dependencies (Python)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Make shard scripts executable
        run: |
          chmod +x .github/scripts/shard.py
          chmod +x .github/scripts/merge_allure.py

      - name: Run sharded tests on node ${{ matrix.shard_index }} / ${{ matrix.shard_count }}
        env:
          SHARD_INDEX: ${{ matrix.shard_index }}
          SHARD_COUNT: ${{ matrix.shard_count }}

          # Use input if non-empty, else fallback to default values
          BASE_URL: ${{ github.event.inputs.base_url != '' && github.event.inputs.base_url || 'https://www.saucedemo.com/' }}
          MARKER:   ${{ github.event.inputs.marker != '' && github.event.inputs.marker || 'regression' }}
          XDIST:    ${{ github.event.inputs.xdist != '' && github.event.inputs.xdist || 'auto' }}
          HEADLESS: ${{ 'true' }} # Non-headless is not allowed in CI runner
          EXTRA_ARGS: ${{ github.event.inputs.extra_args != '' && github.event.inputs.extra_args || '' }}
          RERUNS:   ${{ github.event.inputs.reruns != '' && github.event.inputs.reruns || '1' }}
          RERUNS_DELAY: ${{ github.event.inputs.reruns_delay != '' && github.event.inputs.reruns_delay || '1' }}

          # special envs for group behaviour
          GROUP_MARK: xdist_loadgroup         # name of marker used to tag grouped tests
          GROUP_SHARD_INDEX: 1            # which shard index should run the grouped tests
          GROUP_WORKERS: auto             # number of xdist workers to use on the group shard

        run: |
          set -euo pipefail

          # Per-shard allure results directory
          RESULTS_PATH="allure-results-${SHARD_INDEX}"
          mkdir -p "$RESULTS_PATH"

          # add per-shard allure directory to EXTRA_ARGS
          if [ -n "${EXTRA_ARGS:-}" ]; then
            export EXTRA_ARGS="${EXTRA_ARGS} --alluredir=${RESULTS_PATH}"
          else
            export EXTRA_ARGS="--alluredir=${RESULTS_PATH}"
          fi

          echo "=== ENV BEFORE SHARD ==="
          echo "BASE_URL=${BASE_URL}"
          echo "MARKER=${MARKER}"
          echo "XDIST=${XDIST}"
          echo "HEADLESS=${HEADLESS}"
          echo "EXTRA_ARGS=${EXTRA_ARGS}"
          echo "RERUNS=${RERUNS}"
          echo "RERUNS_DELAY=${RERUNS_DELAY}"

          python .github/scripts/shard.py

      - name: Upload chromedriver log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chromedriver-log-${{ matrix.shard_index }}
          path: /tmp/chromedriver.log
          if-no-files-found: ignore

      - name: Print chromedriver log
        if: failure() || always()
        run: |
          echo "=== CHROMEDRIVER LOG ==="
          if [ -f /tmp/chromedriver.log ]; then
            sed -n '1,400p' /tmp/chromedriver.log
          else
            echo "No chromedriver log found"
          fi

      - name: Upload Allure results artifact (shard)
        uses: actions/upload-artifact@v4
        with:
          name: "allure-results-shard-${{ matrix.shard_index }}"
          path: "allure-results-${{ matrix.shard_index }}"
          if-no-files-found: ignore

      - name: Upload Allure HTML report artifact (shard)
        uses: actions/upload-artifact@v4
        with:
          name: "allure-report-shard-${{ matrix.shard_index }}"
          path: "allure-report-${{ matrix.shard_index }}"
          if-no-files-found: ignore

  merge-allure-reports:
    name: Merge Allure reports (consolidated)
    needs: run-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Show downloaded artifacts (debug)
        run: |
          echo "Downloaded artifact tree:"
          ls -R artifacts || true

      - name: Merge Allure results with script
        run: |
          python .github/scripts/merge_allure.py

      - name: Install Allure CLI (if missing)
        run: |
          if ! command -v allure >/dev/null 2>&1; then
            npm install -g allure-commandline --no-fund --no-audit
          fi

      - name: Generate consolidated Allure report
        run: |
          if [ -d "merged-allure-results" ] && [ "$(ls -A merged-allure-results)" ]; then
            allure generate merged-allure-results -o allure-reports --clean
          else
            echo "merged-allure-results empty â€” skipping report."
          fi

      - name: Upload consolidated Allure results
        uses: actions/upload-artifact@v4
        with:
          name: merged-allure-results
          path: merged-allure-results
          if-no-files-found: ignore

      - name: Upload consolidated Allure HTML report
        uses: actions/upload-artifact@v4
        with:
          name: allure-reports
          path: allure-reports
          if-no-files-found: ignore