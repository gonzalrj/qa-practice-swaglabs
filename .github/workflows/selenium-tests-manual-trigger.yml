name: Manual Selenium Test Run Python 3.12 and Chrome

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Optional: override BASE_URL (leave empty to use entrypoint.sh default)'
        required: false
        default: ''
      marker:
        description: 'Optional: pytest marker (leave empty to use entrypoint.sh default)'
        required: false
        default: ''
      xdist:
        description: 'Optional: pytest-xdist -n value (e.g. auto). Leave empty to use entrypoint.sh default'
        required: false
        default: ''
      headless:
        description: 'Optional: override HEADLESS (true|false). Leave empty to use entrypoint.sh default'
        required: false
        default: ''
      extra_args:
        description: 'Optional: extra pytest args (single string). Leave empty to use entrypoint.sh default'
        required: false
        default: ''
      reruns:
        description: 'Optional: number of reruns (--reruns). Leave empty to use entrypoint.sh default'
        required: false
        default: ''
      reruns_delay:
        description: 'Optional: rerun delay (--reruns-delay). Leave empty to use entrypoint.sh default'
        required: false
        default: ''

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Google Chrome (stable)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip
          wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y /tmp/chrome.deb || (sudo apt-get -f install -y && sudo apt install -y /tmp/chrome.deb)
          google-chrome --version

      - name: Upgrade pip and install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Make entrypoint executable
        run: chmod +x ./entrypoint.sh

      - name: Show entrypoint (debug)
        run: |
          echo "Using entrypoint at: $(pwd)/entrypoint.sh"
          sed -n '1,120p' ./entrypoint.sh || true

      - name: Run tests via entrypoint.sh and generate results
        run: |
          set -euo pipefail
          
          # Define where results go. This is a fixed path the next step expects.
          RESULTS_PATH="allure-results"
          mkdir -p $RESULTS_PATH # Ensure the directory exists

          # Export inputs only when non-empty
          # We force EXTRA_ARGS here to ensure allure results are generated at the known path
          export EXTRA_ARGS="--alluredir $RESULTS_PATH"

          # Export inputs only when non-empty so entrypoint.sh defaults remain intact
          if [ -n "${{ github.event.inputs.base_url }}" ]; then
            echo "Overriding BASE_URL -> '${{ github.event.inputs.base_url }}'"
            export BASE_URL="${{ github.event.inputs.base_url }}"
          fi

          if [ -n "${{ github.event.inputs.marker }}" ]; then
            echo "Overriding MARKER -> '${{ github.event.inputs.marker }}'"
            export MARKER="${{ github.event.inputs.marker }}"
          fi

          if [ -n "${{ github.event.inputs.xdist }}" ]; then
            echo "Overriding XDIST -> '${{ github.event.inputs.xdist }}'"
            export XDIST="${{ github.event.inputs.xdist }}"
          fi

          if [ -n "${{ github.event.inputs.headless }}" ]; then
            echo "Overriding HEADLESS -> '${{ github.event.inputs.headless }}'"
            export HEADLESS="${{ github.event.inputs.headless }}"
          fi

          if [ -n "${{ github.event.inputs.extra_args }}" ]; then
            echo "Overriding EXTRA_ARGS -> '${{ github.event.inputs.extra_args }}'"
            export EXTRA_ARGS="${{ github.event.inputs.extra_args }}"
          fi

          if [ -n "${{ github.event.inputs.reruns }}" ]; then
            echo "Overriding RERUNS -> '${{ github.event.inputs.reruns }}'"
            export RERUNS="${{ github.event.inputs.reruns }}"
          fi

          if [ -n "${{ github.event.inputs.reruns_delay }}" ]; then
            echo "Overriding RERUNS_DELAY -> '${{ github.event.inputs.reruns_delay }}'"
            export RERUNS_DELAY="${{ github.event.inputs.reruns_delay }}"
          fi

          # Show only selected envs (if present)
          [ -n "${BASE_URL-}" ] && echo "  BASE_URL=${BASE_URL}"
          [ -n "${MARKER-}" ] && echo "  MARKER=${MARKER}"
          [ -n "${XDIST-}" ] && echo "  XDIST=${XDIST}"
          [ -n "${HEADLESS-}" ] && echo "  HEADLESS=${HEADLESS}"
          [ -n "${RERUNS-}" ] && echo "  RERUNS=${RERUNS}"
          [ -n "${RERUNS_DELAY-}" ] && echo "  RERUNS_DELAY=${RERUNS_DELAY}"
          [ -n "${EXTRA_ARGS-}" ] && echo "  EXTRA_ARGS=${EXTRA_ARGS}"

          exec ./entrypoint.sh
          
      # Use the Allure Report action to generate and deploy the report
      - name: Generate Allure Report and Deploy to GitHub Pages
        uses: simple-elf/allure-report-action@v2
        # Note: You might need to configure permissions in your repo settings
        # to allow this action to create the report page.
        with:
          gh_pages: true
          # Artifact server is the default way to host within the Actions UI
          allure_history: true

      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AllureReport
          path: allure-history