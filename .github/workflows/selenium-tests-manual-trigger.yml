name: Manual Selenium Test Run Python 3.12 Chrome

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Optional: override BASE_URL (leave empty to use entrypoint.sh default)"
        required: false
        default: ""
      marker:
        description: "Optional: pytest marker (leave empty to use entrypoint.sh default)"
        required: false
        default: ""
      xdist:
        description: "Optional: pytest-xdist -n value (e.g. auto). Leave empty to use entrypoint.sh default"
        required: false
        default: ""
      headless:
        description: "Optional: override HEADLESS (true|false). Leave empty to use entrypoint.sh default"
        required: false
        default: ""
      extra_args:
        description: "Optional: extra pytest args (single string). Leave empty to use entrypoint.sh default"
        required: false
        default: ""
      reruns:
        description: "Optional: number of reruns (--reruns). Leave empty to use entrypoint.sh default"
        required: false
        default: ""
      reruns_delay:
        description: "Optional: rerun delay (--reruns-delay). Leave empty to use entrypoint.sh default"
        required: false
        default: ""

jobs:
  run-tests:
    name: Run tests (sharded)
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      CHROMEDRIVER_LOG: /tmp/chromedriver.log
      GECKODRIVER_LOG: /tmp/geckodriver.log
      EDGEDRIVER_LOG: /tmp/edgedriver.log

    strategy:
      matrix:
        shard_index: [0,1]
        shard_count: [2]

    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Google Chrome (stable)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip
          wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y /tmp/chrome.deb || (sudo apt-get -f install -y && sudo apt install -y /tmp/chrome.deb)
          google-chrome --version

      - name: Upgrade pip and install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug: Show Chrome & system info
        run: |
          echo "=== Chrome versions ==="
          google-chrome --version || true
          google-chrome-stable --version || true
          chromium-browser --version || true
          echo
          echo "=== uname / lsb_release ==="
          uname -a || true
          lsb_release -a || true
          echo
          echo "=== /etc/os-release ==="
          cat /etc/os-release || true

      - name: Make entrypoint executable
        run: chmod +x ./entrypoint.sh

      - name: Make shard script executbale
        run: chmod +x .github/scripts/shard.py

      - name: Make merge-allure script executable
        run: chmod +x .github/scripts/merge_allure.py

      - name: Show entrypoint (debug)
        run: |
          echo "Using entrypoint at: $(pwd)/entrypoint.sh"
          sed -n '1,120p' ./entrypoint.sh || true

      - name: Run sharded tests on node ${{ matrix.shard_index }} / ${{ matrix.shard_count }}
        env:
          SHARD_INDEX: ${{ matrix.shard_index }}
          SHARD_COUNT: ${{ matrix.shard_count }}

          # Optional overrides passed directly as envs (may be empty)
          XDIST: ${{ github.event.inputs.xdist }}
          BASE_URL: ${{ github.event.inputs.base_url }}
          MARKER: ${{ github.event.inputs.marker }}
          HEADLESS: ${{ github.event.inputs.headless }}
          EXTRA_ARGS: ${{ github.event.inputs.extra_args }}
          RERUNS: ${{ github.event.inputs.reruns }}
          RERUNS_DELAY: ${{ github.event.inputs.reruns_delay }}

        run: |
          set -euo pipefail

          RESULTS_PATH="allure-results-${SHARD_INDEX}"
          mkdir -p "$RESULTS_PATH"

          # Use safe expansions so 'set -u' won't fail if envs are absent.
          # Append the --alluredir to EXTRA_ARGS; preserve user EXTRA_ARGS if present.
          if [ -n "${EXTRA_ARGS:-}" ]; then
            export EXTRA_ARGS="${EXTRA_ARGS} --alluredir=${RESULTS_PATH}"
          else
            export EXTRA_ARGS="--alluredir=${RESULTS_PATH}"
          fi

          # OPTIONAL guarded exports (only set when non-empty). Use :- safe form.
          [ -n "${BASE_URL:-}" ]      && export BASE_URL="${BASE_URL:-}"
          [ -n "${MARKER:-}" ]        && export MARKER="${MARKER:-}"
          [ -n "${XDIST:-}" ]         && export XDIST="${XDIST:-}"
          [ -n "${HEADLESS:-}" ]      && export HEADLESS="${HEADLESS:-}"
          [ -n "${RERUNS:-}" ]        && export RERUNS="${RERUNS:-}"
          [ -n "${RERUNS_DELAY:-}" ]  && export RERUNS_DELAY="${RERUNS_DELAY:-}"

          # Ensure script is executable (safe noop if already set)
          chmod +x .github/scripts/shard.py || true

          # Delegate sharding to the external script
          python .github/scripts/shard.py

      - name: Install Node (for Allure CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Generate Allure report (per-shard) (optional)
        run: |
          if [ -d "allure-results-${{ matrix.shard_index }}" ] && [ "$(ls -A allure-results-${{ matrix.shard_index }})" ]; then
            npm install -g allure-commandline --no-fund --no-audit
            mkdir -p "allure-report-${{ matrix.shard_index }}"
            allure generate "allure-results-${{ matrix.shard_index }}" -o "allure-report-${{ matrix.shard_index }}" --clean || true
            ls -la "allure-report-${{ matrix.shard_index }}" || true
          else
            echo "No allure-results for shard ${{ matrix.shard_index }}"
          fi

      - name: Upload Allure results artifact (shard)
        uses: actions/upload-artifact@v4
        with:
          name: "allure-results-shard-${{ matrix.shard_index }}"
          path: "allure-results-${{ matrix.shard_index }}"
          if-no-files-found: ignore

      - name: Upload Allure HTML report artifact (shard)
        uses: actions/upload-artifact@v4
        with:
          name: "allure-report-shard-${{ matrix.shard_index }}"
          path: "allure-report-${{ matrix.shard_index }}"
          if-no-files-found: ignore

  merge-allure-reports:
    name: Merge Allure reports (consolidated)
    needs: run-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Show downloaded artifacts (debug)
        run: |
          echo "Downloaded artifact tree:"
          ls -R artifacts || true

      - name: Merge Allure results with script
        run: |
          set -euo pipefail
          python .github/scripts/merge_allure.py

      - name: Ensure Allure CLI is available (install if missing) and generate report
        run: |
          set -euo pipefail
          # If allure is not present, install via npm
          if ! command -v allure >/dev/null 2>&1; then
            echo "Allure CLI not found — installing via npm"
            # Install Node + npm (GitHub runner usually has node but ensure)
            # Use the actions/setup-node earlier if you prefer; here we attempt install only
            npm install -g allure-commandline --no-fund --no-audit
          else
            echo "Allure CLI present at: $(which allure)"
          fi

          # Generate HTML report from merged-allure-results if present
          if [ -d "merged-allure-results" ] && [ "$(ls -A merged-allure-results)" ]; then
            echo "Generating consolidated Allure HTML report..."
            allure generate merged-allure-results -o allure-reports --clean || true
            echo "Allure report location: ./allure-reports"
            ls -la allure-reports || true
          else
            echo "merged-allure-results missing or empty — skipping Allure generation."
          fi

      - name: Upload consolidated Allure results (raw merged results)
        uses: actions/upload-artifact@v4
        with:
          name: merged-allure-results
          path: merged-allure-results
          if-no-files-found: ignore

      - name: Upload consolidated Allure HTML report
        uses: actions/upload-artifact@v4
        with:
          name: allure-reports
          path: allure-reports
          if-no-files-found: ignore